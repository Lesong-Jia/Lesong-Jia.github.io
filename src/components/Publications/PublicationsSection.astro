---
/**
 * 研究与发表：左侧标题，中间四个方向筛选按钮（选中态），右侧查看更多；列表每项左图右文
 */
import siteData from "@config/siteData.json";
import { Image } from "astro:assets";
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import { getLocalizedPath } from "@/utils/i18n";

// 从 URL 路径中提取语言
const lang = (Astro.url.pathname.startsWith("/en/") ? "en" : "zh") as "zh" | "en";
const DIRECTION_ALL = lang === "en" ? "All Directions" : "所有方向";
const DIRECTIONS = lang === "en" 
	? [DIRECTION_ALL, "Multimodal Interaction", "Robot Interaction", "Situation Awareness", "Virtual and Augmented Reality"] as const
	: [DIRECTION_ALL, "多模态交互", "机器人交互", "态势感知", "虚拟与增强现实"] as const;

// 内容里的 direction 是中文，筛选按钮的 data-direction 随语言；用此映射使列表项与按钮一致以便客户端筛选
const directionToFilterValue: Record<string, string> = lang === "en"
	? { "多模态交互": "Multimodal Interaction", "机器人交互": "Robot Interaction", "态势感知": "Situation Awareness", "虚拟与增强现实": "Virtual and Augmented Reality" }
	: { "多模态交互": "多模态交互", "机器人交互": "机器人交互", "态势感知": "态势感知", "虚拟与增强现实": "虚拟与增强现实" };

// 主页只显示勾选「在主页显示」的发表；研究方向页显示全部
const items = await getCollection("publications", ({ data }) => data.draft !== true && data.showOnHomepage === true);

// 获取作者位次：1=一作, 2=二作, 3+=其他
function getAuthorPosition(authors: string, authorName: string): number {
	const authorList = authors.split(",").map((a) => a.trim());
	// 检查完整名字匹配（支持 "Lesong Jia" 或 "Jia Lesong" 格式）
	const index = authorList.findIndex((a) => {
		const normalized = a.toLowerCase();
		const nameParts = authorName.toLowerCase().split(" ");
		// 检查是否包含名字的所有部分
		return nameParts.every((part) => normalized.includes(part));
	});
	if (index === -1) return 999; // 未找到，排最后
	if (index === 0) return 1; // 一作
	if (index === 1) return 2; // 二作
	return 3; // 其他位次
}

// 排序：先按作者位次（一作>二作>其他），再按年份（新的在前）
const sorted = items.sort((a, b) => {
	const posA = getAuthorPosition(a.data.authors, siteData.author.name);
	const posB = getAuthorPosition(b.data.authors, siteData.author.name);
	if (posA !== posB) return posA - posB; // 先按位次排序
	return b.data.year - a.data.year; // 再按年份降序
});

function highlightAuthor(authors: string, name: string): (string | { bold: string })[] {
	if (!name || !authors.includes(name)) return [authors];
	const parts = authors.split(name);
	const out: (string | { bold: string })[] = [];
	parts.forEach((part, i) => {
		out.push(part);
		if (i < parts.length - 1) out.push({ bold: name });
	});
	return out;
}
---

<section id="publications" class="site-container scroll-mt-10 pt-6 pb-10 md:pt-8 md:pb-12" data-direction-all={DIRECTION_ALL}>
	<div class="max-w-6xl">
		<!-- 标题 -->
		<div class="mb-6 md:mb-8">
			<h2 class="h2 text-pretty uppercase">
				{lang === "en" ? "Research Directions & Representative Publications" : "研究方向与代表性发表"}
			</h2>
		</div>
		<!-- 五个按钮 + 查看更多：同一行 -->
		<div class="mb-8 flex flex-wrap items-center justify-between gap-6 md:mb-10">
			<div class="flex flex-wrap items-center gap-x-6 gap-y-1">
				{DIRECTIONS.map((d) => (
					<button
						type="button"
						class="publication-filter -mb-px border-b-2 border-transparent pb-1.5 pt-0.5 text-sm text-base-500 transition-colors hover:text-base-800 data-[active=true]:border-base-900 data-[active=true]:text-base-900 data-[active=true]:font-medium"
						data-direction={d}
						data-active={d === DIRECTION_ALL ? "true" : "false"}
					>
						{d}
					</button>
				))}
			</div>
			<a href={getLocalizedPath("/publications", lang)} class="text-sm text-base-600 underline underline-offset-2 hover:text-base-900">
				{lang === "en" ? "View More" : "查看更多"}
			</a>
		</div>

		<!-- 列表：每项左图右文 -->
		<ul class="space-y-4" aria-label="发表列表">
			{sorted.map((entry) => {
				const { title, venue, authors, doi, thumbnail, direction } = entry.data;
				const doiUrl = doi ? `https://doi.org/${doi}` : "";
				// pub-10 的图用静态路径兜底，避免 content collection 图片解析导致不显示
				const useStaticThumb = entry.id.includes("pub-10");
				const thumbSrc = useStaticThumb ? "/images/publications/pub10.png" : null;
				return (
					<li
						class="publication-item flex items-start gap-4 p-4 md:gap-6 md:p-5"
						data-direction={directionToFilterValue[direction] ?? direction}
					>
						<div class="h-28 w-28 shrink-0 overflow-hidden rounded-md bg-white md:h-36 md:w-36">
							{thumbSrc ? (
								<img src={thumbSrc} alt="" width={288} height={288} class="h-full w-full object-contain" />
							) : thumbnail ? (
								<Image
									src={thumbnail}
									alt=""
									width={288}
									height={288}
									class="h-full w-full object-contain"
								/>
							) : (
								<div class="flex h-full w-full items-center justify-center text-base-400 text-xs">图</div>
							)}
						</div>
						<div class="flex min-h-28 flex-1 flex-col justify-between min-w-0 md:min-h-36">
							<div class="pt-0">
								<h3 class="mt-0 font-heading-2 text-lg font-medium text-base-900 md:text-xl">
									{title}
								</h3>
								{venue && <p class="mt-1 text-sm text-base-600">{venue}</p>}
								<p class="mt-1 text-sm text-base-600">
									{highlightAuthor(authors, siteData.author.name).map((seg) =>
										typeof seg === "string" ? seg : <strong>{seg.bold}</strong>
									)}
								</p>
							</div>
							{doiUrl && (
								<p class="mt-2">
									<a href={doiUrl} target="_blank" rel="noopener noreferrer" class="break-all text-sm text-base-600 underline underline-offset-2 hover:text-base-900">
										{doiUrl}
									</a>
								</p>
							)}
						</div>
					</li>
				);
			})}
		</ul>
	</div>
</section>

<script is:inline>
	(function () {
		function init() {
			var section = document.getElementById("publications");
			if (!section) return;
			var directionAll = section.getAttribute("data-direction-all") || "";
			var filters = section.querySelectorAll(".publication-filter");
			var itemEls = section.querySelectorAll(".publication-item");

			function setActive(button) {
				filters.forEach(function (b) {
					b.setAttribute("data-active", b === button ? "true" : "false");
				});
			}

			function filter(dir) {
				var showAll = dir === directionAll;
				itemEls.forEach(function (el) {
					var itemDir = el.getAttribute("data-direction") || "";
					el.style.display = showAll || itemDir === dir ? "" : "none";
				});
			}

			filters.forEach(function (btn) {
				btn.addEventListener("click", function () {
					var dir = btn.getAttribute("data-direction") || directionAll;
					setActive(btn);
					filter(dir);
				});
			});

			var allBtn = Array.prototype.find.call(filters, function (b) { return b.getAttribute("data-direction") === directionAll; });
			if (allBtn) setActive(allBtn);
		}

		if (document.readyState === "loading") {
			document.addEventListener("DOMContentLoaded", init);
		} else {
			init();
		}
		document.addEventListener("astro:page-load", init);
	})();
</script>
