---
import BaseLayout from "@layouts/BaseLayout.astro";
import type { InferGetStaticPropsType } from "astro";
import type { CollectionEntry } from "astro:content";
import { getCollection, render } from "astro:content";
import { Image } from "astro:assets";
import { getLocalizedPath, t } from "@/utils/i18n";

export async function getStaticPaths() {
	const items = await getCollection("news", ({ data }) => data.draft !== true);
	const langs = ["zh", "en"];
	const paths = [];
	for (const lang of langs) {
		for (const entry of items) {
			paths.push({
				params: { lang, slug: entry.id },
				props: { entry, lang },
			});
		}
	}
	return paths;
}

type Props = InferGetStaticPropsType<typeof getStaticPaths>;
const { entry, lang } = Astro.props as { entry: CollectionEntry<"news">; lang: "zh" | "en" };
const { Content } = await render(entry);
const { title, description, descriptionEn, date, heroImage, link, acceptedBy, paperTitle, authors, abstract } = entry.data;
const dateStr = date.toLocaleDateString(lang === "en" ? "en-US" : "zh-CN", { year: "numeric", month: "long", day: "numeric" });

// 根据语言生成标题
const pageTitle = lang === "en"
	? (acceptedBy
		? acceptedBy.includes("最佳论文奖") || acceptedBy.toLowerCase().includes("best paper")
			? `Our paper received the Best Paper Award at ${acceptedBy.replace(/（最佳论文奖）|\(Best Paper Award\)/gi, "").trim()}`
			: `Our paper was accepted by ${acceptedBy}`
		: title)
	: (acceptedBy
		? acceptedBy.includes("最佳论文奖")
			? `我们的论文获得了${acceptedBy.replace(/（最佳论文奖）/, "").trim()}最佳论文`
			: `我们的论文被${acceptedBy}接收`
		: title);

const abstractSingleLine = typeof abstract === "string" ? abstract.replace(/\s+/g, " ").trim() : "";

// 详情页首段：英文优先用 descriptionEn，否则用 description 并做日期/作者剥离
const descriptionWithoutDate = lang === "en"
	? (descriptionEn ?? description
		.replace(/^\d{4}年\d{1,2}月\d{1,2}日[，、]\s*/, "")
		.replace(/作者：[^。]*。\s*$/, "")
		.replace(/^[A-Z][a-z]+ \d{1,2}, \d{4},?\s*/, "")
		.replace(/Authors?:[^.]*\.\s*$/i, "")
		.trim())
	: description
		.replace(/^\d{4}年\d{1,2}月\d{1,2}日[，、]\s*/, "")
		.replace(/作者：[^。]*。\s*$/, "")
		.trim();
---

<BaseLayout title={pageTitle} description={description} navStartStyle="default">
	<article class="site-container pt-24 pb-16 md:pt-36 md:pb-24">
		<div class="mx-auto max-w-3xl">
			<header class="mb-8">
				<time class="text-base text-base-500">{dateStr}</time>
				<h1 class="mt-2 font-heading-1 text-3xl font-medium text-pretty md:text-4xl">
					{pageTitle}
				</h1>
				<p class="mt-4 text-base text-base-600">
					{descriptionWithoutDate}
				</p>
			</header>

			{heroImage && (
				<div class="mb-8">
					<Image
						src={heroImage}
						alt=""
						width={1920}
						height={1440}
						quality={100}
						class="w-full h-auto"
					/>
				</div>
			)}
			<dl class="space-y-4 text-base-700">
				{paperTitle && (
					<div>
						<dt class="text-sm font-medium text-base-500">{t("news.paperTitle", lang)}</dt>
						<dd class="mt-1">{paperTitle}</dd>
					</div>
				)}
				{authors && (
					<div>
						<dt class="text-sm font-medium text-base-500">{t("news.authors", lang)}</dt>
						<dd class="mt-1">{authors}</dd>
					</div>
				)}
				{abstractSingleLine ? (
					<div>
						<dt class="text-sm font-medium text-base-500">{t("news.abstract", lang)}</dt>
						<dd class="mt-1">{abstractSingleLine}</dd>
					</div>
				) : (
					<div class="markdown-content max-w-none">
						<Content />
					</div>
				)}
			</dl>

			<div class="mt-8 flex flex-wrap items-center justify-end gap-4">
				{link && (
					<a
						href={link}
						target="_blank"
						rel="noopener noreferrer"
						class="text-sm text-base-600 underline underline-offset-2 hover:text-base-900"
					>
						{t("news.readFull", lang)}
					</a>
				)}
				<a
					href={getLocalizedPath("/news", lang)}
					class="text-sm text-base-600 underline underline-offset-2 hover:text-base-900"
				>
					{t("news.backToAll", lang)}
				</a>
				<a
					href={getLocalizedPath("/", lang)}
					class="text-sm text-base-600 underline underline-offset-2 hover:text-base-900"
				>
					{t("news.backToHome", lang)}
				</a>
			</div>
		</div>
	</article>
</BaseLayout>
