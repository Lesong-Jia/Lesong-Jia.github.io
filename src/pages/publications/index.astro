---
import { Image } from "astro:assets";
import BaseLayout from "@layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import siteData from "@config/siteData.json";
import directionMultimodal from "@images/direction-multimodal.png";
import directionRobot from "@images/direction-robot.png";
import directionSituation from "@images/direction-situation.png";
import directionVr from "@images/direction-vr.png";

// 获取所有发表
const allPublications = await getCollection("publications", ({ data }) => data.draft !== true);

// 获取作者位次：1=一作, 2=二作, 3+=其他
function getAuthorPosition(authors: string, authorName: string): number {
	const authorList = authors.split(",").map((a) => a.trim());
	// 检查完整名字匹配（支持 "Lesong Jia" 或 "Jia Lesong" 格式）
	const index = authorList.findIndex((a) => {
		const normalized = a.toLowerCase();
		const nameParts = authorName.toLowerCase().split(" ");
		// 检查是否包含名字的所有部分
		return nameParts.every((part) => normalized.includes(part));
	});
	if (index === -1) return 999; // 未找到，排最后
	if (index === 0) return 1; // 一作
	if (index === 1) return 2; // 二作
	return 3; // 其他位次
}

// 排序：先按作者位次（一作>二作>其他），再按年份（新的在前）
const sortedPublications = allPublications.sort((a, b) => {
	const posA = getAuthorPosition(a.data.authors, siteData.author.name);
	const posB = getAuthorPosition(b.data.authors, siteData.author.name);
	if (posA !== posB) return posA - posB; // 先按位次排序
	return b.data.year - a.data.year; // 再按年份降序
});

// 高亮作者名字
function highlightAuthor(authors: string, name: string): (string | { bold: string })[] {
	if (!name || !authors.includes(name)) return [authors];
	const parts = authors.split(name);
	const out: (string | { bold: string })[] = [];
	parts.forEach((part, i) => {
		out.push(part);
		if (i < parts.length - 1) out.push({ bold: name });
	});
	return out;
}

// 四个研究方向的内容
const researchProjects = [
	{
		title: "多模态交互",
		direction: "多模态交互",
		image: directionMultimodal,
		imageSmall: true,
		imageMaxSize: 88,
		content: `多模态交互研究致力于通过整合手势、语音、姿态等多种输入通道，创造更自然、高效的人机交互方式。

我们的工作涵盖手势识别与编码（如基于手部骨架的非轨迹手势识别、连续手部关节运动的离散语义、空中手势编码方法 DigCode）、语音与姿态融合交互（如 Speech+ Posture 在多屏与大屏场景下的应用），以及图形元素与手势阈值对交互行为的影响。相关成果发表在 International Journal of Human-Computer Studies、Sensors、Multimedia Tools and Applications、IHSI 等期刊与会议上。

我们关注多模态输入在真实场景中的可用性与表现，并持续探索其在大型交互界面与泛在计算环境中的应用潜力。`,
	},
	{
		title: "机器人交互",
		direction: "机器人交互",
		image: directionRobot,
		imageSmall: true,
		imageMaxSize: 90,
		imageOffsetDown: true,
		content: `机器人交互研究关注人机协作中的情感调节、用户需求理解与辅助技术设计，旨在让机器人系统更贴合用户期望、更易用、更可信。

在辅助技术方面，我们聚焦轮椅安装机械臂（WMRA）的功能与界面：通过用户访谈与原型测试，探究用户对语音控制自动化机械臂的期望、对反馈方式与信息呈现的偏好，以及手动控制时的反馈模态需求。相关成果获 HRI 最佳论文，并发表于 ICORR、HFES 等会议。

在情感交互方面，我们研究机器人介导的情绪调节如何影响用户的情绪、决策与人机信任，包括共情与非共情调节策略在不同情境下的效果，以及基于视频与游戏模拟的实验方法。成果发表于 International Journal of Social Robotics、HFES 等期刊与会议。`,
	},
	{
		title: "态势感知",
		direction: "态势感知",
		image: directionSituation,
		content: `态势感知研究关注用户在复杂动态环境中的理解与决策，重点包括自动驾驶接管场景中的驾驶员态势感知，以及无人机监控中的操作员态势感知与人机协同。

在自动驾驶方面，我们研究接管过程中驾驶员对周围车辆的态势感知、交通条件与接管表现的关系，以及多模态数据（生理与情境）与机器学习对驾驶员态势感知的预测；并探讨信息类型、解释方式与系统错误如何影响用户信任与态势感知，以及关键性自适应显示的设计与评估。成果发表于 CHI、International Journal of Human–Computer Interaction、IEEE Transactions on Human-Machine Systems、Transportation Research Part F、HFES 等。

在无人机方面，我们研究多无人机监控中的态势感知（环境复杂度、界面设计与人类–AI 差异）、固定翼无人机监视中的人类知觉边界、目标显眼性，以及面向分布式数据流的态势理论与查询生成。成果发表于 IJHCI、ICHMS 等。`,
	},
	{
		title: "虚拟与增强现实",
		direction: "虚拟与增强现实",
		image: directionVr,
		imageSmall: true,
		imageMaxSize: 97,
		content: `虚拟与增强现实研究关注虚拟环境中的输入与交互设计，以及用户注意与行为建模，以提升 VR 中的操作效率与体验。

我们的工作包括：虚拟环境中按钮尺寸与徒手点击表现、徒手三维目标选择技术的可用性比较、手指点击交互任务的建模与评估；徒手点击与键盘控制在虚拟按钮选择任务中的眼动行为差异；手眼协调与徒手点击交互区域；以及基于多模态眼手数据预测用户在 VR 选择任务中的注意状态。相关成果发表在 Applied Sciences、Symmetry、Multimedia Tools and Applications、Electronics、Journal on Multimodal User Interfaces、IHSI、Human Systems Engineering and Design 等期刊与会议上。

我们致力于从交互技术与用户行为两方面推进 VR 界面的可用性与自适应设计。`,
	},
];
---

<BaseLayout title="研究方向" description="研究方向。" navStartStyle="default">
	<div class="site-container pt-24 pb-16 md:pt-36 md:pb-24">
		<div class="mb-12 flex flex-wrap items-end justify-between gap-4">
			<h1 class="h2 text-pretty uppercase">研究方向</h1>
			<a
				href="/"
				class="text-sm text-base-600 underline underline-offset-2 hover:text-base-900"
			>
				返回主页
			</a>
		</div>

		<div class="space-y-16">
			{researchProjects.map((project) => (
				<section class="flex flex-col gap-8 md:flex-row md:items-start">
					<!-- 左侧图片 -->
					<div class="w-full shrink-0 md:w-[32rem]">
						<div class="aspect-[4/3] w-full overflow-hidden bg-white md:h-[384px] flex items-center justify-center">
							<Image
								src={project.image}
								alt={project.title}
								width={1280}
								height={960}
								quality={95}
								class={project.imageSmall ? `h-full w-full max-h-[${project.imageMaxSize ?? 85}%] max-w-[${project.imageMaxSize ?? 85}%] object-contain ${project.imageOffsetDown ? "mt-1" : ""}` : "h-full w-full object-cover"}
							/>
						</div>
					</div>

					<!-- 右侧文字内容（可滚动） -->
					<div class="min-w-0 flex-1 flex flex-col md:h-[384px]">
						<h2 class="mb-4 shrink-0 font-heading-2 text-2xl font-semibold text-base-900 md:text-3xl">
							{project.title}
						</h2>
						<div class="markdown-content flex-1 pr-2 text-base-700">
							{project.content.split("\n\n").map((paragraph) => (
								<p class="mb-4 leading-relaxed last:mb-0">{paragraph}</p>
							))}

							{/* 相关发表列表 */}
							{(() => {
								const relatedPubs = sortedPublications.filter(
									(entry) => entry.data.direction === project.direction,
								);
								if (relatedPubs.length === 0) return null;
								return (
									<div class="mt-8 border-t border-base-300 pt-6">
										<h3 class="mb-4 font-heading-2 text-lg font-semibold text-base-900">
											相关发表
										</h3>
										<ul class="space-y-4">
											{relatedPubs.map((entry) => {
												const { title, authors, venue, year, doi } = entry.data;
												const doiUrl = doi ? `https://doi.org/${doi}` : "";
												return (
													<li class="text-sm">
														<p class="leading-relaxed">
															<span class="font-medium">
																{highlightAuthor(authors, siteData.author.name).map((seg) =>
																	typeof seg === "string" ? seg : <strong>{seg.bold}</strong>
																)}
															</span>. {title}.{" "}
															{venue && <span class="italic">{venue}</span>}
															{year && `, ${year}`}.
														</p>
														{doiUrl && (
															<p class="mt-1">
																<a
																	href={doiUrl}
																	target="_blank"
																	rel="noopener noreferrer"
																	class="text-base-600 underline underline-offset-2 hover:text-base-900"
																>
																	DOI: {doi}
																</a>
															</p>
														)}
													</li>
												);
											})}
										</ul>
									</div>
								);
							})()}
						</div>
					</div>
				</section>
			))}
		</div>
	</div>
</BaseLayout>

<style>
	.markdown-content {
		overflow-y: scroll;
		scrollbar-width: thin;
		scrollbar-color: transparent transparent;
	}

	.markdown-content:hover {
		scrollbar-color: var(--color-base-400) transparent;
	}

	/* Webkit browsers (Chrome, Safari, Edge) */
	.markdown-content::-webkit-scrollbar {
		width: 6px;
	}

	.markdown-content::-webkit-scrollbar-track {
		background: transparent;
	}

	.markdown-content::-webkit-scrollbar-thumb {
		background-color: transparent;
		border-radius: 3px;
		transition: background-color 0.2s ease;
	}

	.markdown-content:hover::-webkit-scrollbar-thumb {
		background-color: var(--color-base-400) !important;
	}

	.markdown-content::-webkit-scrollbar-thumb:hover {
		background-color: var(--color-base-500) !important;
	}

	/* Firefox */
	@-moz-document url-prefix() {
		.markdown-content {
			scrollbar-width: thin;
			scrollbar-color: transparent transparent;
		}

		.markdown-content:hover {
			scrollbar-color: var(--color-base-400) transparent;
		}
	}
</style>
